import{P as H}from"./pdf-lib-F-JeKLTy.js";import{C as U,P as D,D as F}from"./index-BxPmkc4Q.js";import"./vendor-react-43aI2jku.js";import"./vendor-ui-Dlm9CAfc.js";async function L(r){return new Promise((n,o)=>{const t=new Image;t.onload=()=>n(t),t.onerror=a=>o(a),t.src=r})}async function q(r,n,o={}){const t=o.size??U,a=o.bg??"transparent",x=o.captionBg??"rgba(255,255,255,0.82)",u=o.textColor??"#111",s=o.format??"jpeg",i=o.quality??D,l=o.transform??F,c=document.createElement("canvas");c.width=t,c.height=t;const e=c.getContext("2d");if(!e)throw new Error("No 2D context");a!=="transparent"&&(e.fillStyle=a,e.fillRect(0,0,t,t));const m=await L(r.url),f=Math.max(t/m.width,t/m.height)*l.scale,y=Math.round(m.width*f),b=Math.round(m.height*f),T=Math.round((t-y)/2+l.tx/100*t),B=Math.round((t-b)/2+l.ty/100*t);e.imageSmoothingQuality="high",e.drawImage(m,T,B,y,b);const M=.06,R=.34,P=Math.max(72,Math.round(t*M)),w=Math.round(P*.22),C=Math.round(P*R),A=Math.round(C*1.25);if(n&&n.trim()){e.font=`${C}px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial`,e.fillStyle=u,e.textBaseline="top";const p=t-w*2;if(n.includes(`
`)||e.measureText(n).width>p){const h=O(e,n,p),g=Math.max(A,h.length*A),_=Math.max(P,w+g+w);e.fillStyle=x,e.fillRect(0,t-_,t,_),e.fillStyle=u;let E=t-_+w;for(const j of h)e.fillText(j,w,E,p),E+=A}else{const h=P;e.fillStyle=x,e.fillRect(0,t-h,t,h);let g=n;if(e.measureText(g).width>p){for(;g.length&&e.measureText(g+"…").width>p;)g=g.slice(0,-1);g+="…"}e.fillStyle=u,e.textBaseline="middle",e.fillText(g,w,t-h/2)}}const S=s==="png"?"image/png":"image/jpeg",I=await new Promise((p,v)=>c.toBlob(h=>h?p(h):v(new Error("toBlob failed")),S,S==="image/jpeg"?i:void 0));return{bytes:new Uint8Array(await I.arrayBuffer()),mime:S,width:t,height:t}}function z(r,n="story-squares.pdf"){const o=new Blob([r],{type:"application/pdf"}),t=document.createElement("a"),a=URL.createObjectURL(o);t.href=a,t.download=n,document.body.appendChild(t),t.click(),t.remove(),URL.revokeObjectURL(a)}function O(r,n,o){const t=n.replace(/\r\n?/g,`
`).split(`
`),a=[];for(const x of t){const u=x.split(/\s+/);let s="";for(const i of u){const l=s?s+" "+i:i;if(r.measureText(l).width<=o)s=l;else if(s&&a.push(s),r.measureText(i).width>o){let c="";for(const e of i){const m=c+e;r.measureText(m).width<=o?c=m:(a.push(c),c=e)}s=c}else s=i}a.push(s)}return a}async function G(r,n,o,t={}){const a=t.size??U,x=t.format??"jpeg",u=t.quality??D,s=t.onProgress,i=await H.create(),l=r.length,c=performance.now(),e=d=>{if(!s)return;const f=performance.now()-c,y=Math.round(d/l*100),b=d>0?f/d*(l-d):void 0;s({done:d,total:l,elapsedMs:f,etaMs:b,pct:y})};e(0);for(let d=0;d<l;d++){const f=r[d],y=(n[f.id]??"").trim(),b=o[f.id]??F,{bytes:T,mime:B,width:M,height:R}=await q(f,y,{size:a,format:x,quality:u,transform:b,bg:t.bg,captionBg:t.captionBg,textColor:t.textColor}),P=B==="image/png"?await i.embedPng(T):await i.embedJpg(T);i.addPage([M,R]).drawImage(P,{x:0,y:0,width:M,height:R}),e(d+1),await new Promise(C=>setTimeout(C,0))}const m=await i.save();z(m)}export{G as exportCardsToPdf};
