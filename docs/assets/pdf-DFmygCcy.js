import{P as H}from"./pdf-lib-F-JeKLTy.js";import{C as _,D as j}from"./index-Cn5_hIXV.js";import"./vendor-react-43aI2jku.js";import"./vendor-ui-Dlm9CAfc.js";async function I(r){return new Promise((n,o)=>{const t=new Image;t.onload=()=>n(t),t.onerror=a=>o(a),t.src=r})}async function q(r,n,o={}){const t=o.size??_,a=o.bg??"transparent",x=o.captionBg??"rgba(255,255,255,0.82)",u=o.textColor??"#111",s=o.format??"jpeg",i=o.quality??.85,l=o.transform??j,c=document.createElement("canvas");c.width=t,c.height=t;const e=c.getContext("2d");if(!e)throw new Error("No 2D context");a!=="transparent"&&(e.fillStyle=a,e.fillRect(0,0,t,t));const m=await I(r.url),f=Math.max(t/m.width,t/m.height)*l.scale,y=Math.round(m.width*f),b=Math.round(m.height*f),T=Math.round((t-y)/2+l.tx/100*t),B=Math.round((t-b)/2+l.ty/100*t);e.imageSmoothingQuality="high",e.drawImage(m,T,B,y,b);const R=.06,C=.34,M=Math.max(72,Math.round(t*R)),w=Math.round(M*.22),P=Math.round(M*C),S=Math.round(P*1.25);if(n&&n.trim()){e.font=`${P}px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial`,e.fillStyle=u,e.textBaseline="top";const p=t-w*2;if(n.includes(`
`)||e.measureText(n).width>p){const h=L(e,n,p),g=Math.max(S,h.length*S),v=Math.max(M,w+g+w);e.fillStyle=x,e.fillRect(0,t-v,t,v),e.fillStyle=u;let U=t-v+w;for(const F of h)e.fillText(F,w,U,p),U+=S}else{const h=M;e.fillStyle=x,e.fillRect(0,t-h,t,h);let g=n;if(e.measureText(g).width>p){for(;g.length&&e.measureText(g+"…").width>p;)g=g.slice(0,-1);g+="…"}e.fillStyle=u,e.textBaseline="middle",e.fillText(g,w,t-h/2)}}const A=s==="png"?"image/png":"image/jpeg",D=await new Promise((p,E)=>c.toBlob(h=>h?p(h):E(new Error("toBlob failed")),A,A==="image/jpeg"?i:void 0));return{bytes:new Uint8Array(await D.arrayBuffer()),mime:A,width:t,height:t}}function z(r,n="story-squares.pdf"){const o=new Blob([r],{type:"application/pdf"}),t=document.createElement("a"),a=URL.createObjectURL(o);t.href=a,t.download=n,document.body.appendChild(t),t.click(),t.remove(),URL.revokeObjectURL(a)}function L(r,n,o){const t=n.replace(/\r\n?/g,`
`).split(`
`),a=[];for(const x of t){const u=x.split(/\s+/);let s="";for(const i of u){const l=s?s+" "+i:i;if(r.measureText(l).width<=o)s=l;else if(s&&a.push(s),r.measureText(i).width>o){let c="";for(const e of i){const m=c+e;r.measureText(m).width<=o?c=m:(a.push(c),c=e)}s=c}else s=i}a.push(s)}return a}async function Q(r,n,o,t={}){const a=t.size??_,x=t.format??"jpeg",u=t.quality??.85,s=t.onProgress,i=await H.create(),l=r.length,c=performance.now(),e=d=>{if(!s)return;const f=performance.now()-c,y=Math.round(d/l*100),b=d>0?f/d*(l-d):void 0;s({done:d,total:l,elapsedMs:f,etaMs:b,pct:y})};e(0);for(let d=0;d<l;d++){const f=r[d],y=(n[f.id]??"").trim(),b=o[f.id]??j,{bytes:T,mime:B,width:R,height:C}=await q(f,y,{size:a,format:x,quality:u,transform:b,bg:t.bg,captionBg:t.captionBg,textColor:t.textColor}),M=B==="image/png"?await i.embedPng(T):await i.embedJpg(T);i.addPage([R,C]).drawImage(M,{x:0,y:0,width:R,height:C}),e(d+1),await new Promise(P=>setTimeout(P,0))}const m=await i.save();z(m)}export{Q as exportCardsToPdf};
